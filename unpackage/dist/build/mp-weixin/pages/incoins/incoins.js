(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/incoins/incoins"],{"13cf":function(e,t,n){"use strict";var a;n.d(t,"b",(function(){return c})),n.d(t,"c",(function(){return i})),n.d(t,"a",(function(){return a}));var c=function(){var e=this,t=e.$createElement;e._self._c},i=[]},5073:function(e,t,n){"use strict";n.r(t);var a=n("c334"),c=n.n(a);for(var i in a)"default"!==i&&function(e){n.d(t,e,(function(){return a[e]}))}(i);t["default"]=c.a},"765c":function(e,t,n){"use strict";n.r(t);var a=n("13cf"),c=n("5073");for(var i in c)"default"!==i&&function(e){n.d(t,e,(function(){return c[e]}))}(i);n("e66a");var o,r=n("f0c5"),s=Object(r["a"])(c["default"],a["b"],a["c"],!1,null,null,null,!1,a["a"],o);t["default"]=s.exports},"7f07":function(e,t,n){},c334:function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n=getApp(),a={data:function(){return{items:[{name:"1元",money:"1",remark:"1"},{name:"2元",money:"2",remark:"2"},{name:"3元",money:"3",remark:"3"},{name:"4元",money:"4",remark:"4"},{name:"5元",money:"5",remark:"5"},{name:"6元",money:"6",remark:"6"}],val:2,money_value:2,openid:null,merid:0,phonenum:"4006315515",disabled:!1,deviceId:"",deviceName:"",port:"",adimg:"",serviceId:"",tempid:"",notycharacteristicsId:"",characteristicsId:"",recv_number:"",recv_value:"",send_number:""}},onLoad:function(t){var a=this;this.getTemp(t.name),this.setData({deviceId:t.id,deviceName:t.name,port:t.port,adimg:"/static/images/ad1.png",phonenum:t.phonenum,merid:t.merid,openid:n.globalData.user&&n.globalData.user.openid?n.globalData.user.openid:""}),e.stopBluetoothDevicesDiscovery({success:function(e){}}),e.login({success:function(t){t.code&&(e.getUserInfo({withCredentials:!0,success:function(t){var n={};n.avatarUrl=t.userInfo.avatarUrl,n.nickName=t.userInfo.nickName,e.setStorageSync("userInfo",n)}}),e.request({url:"https://app.tengfuchong.com/applet/getWxUserInfo?code="+t.code,success:function(t){var n=t.data;200===n.code?a.setData({openid:n.openid}):e.showModal({title:"提示",content:n.message||"未获取到用户",success:function(t){e.switchTab({url:"/pages/device/device"})}})},fail:function(t){console.log("error",t),e.showModal({title:"提示",content:JSON.stringify(t),success:function(t){e.switchTab({url:"/pages/device/device"})}})}}))}})},onReady:function(){var t=this;e.openBluetoothAdapter({success:function(n){console.log("初始化蓝牙适配器成功"),console.log("MAC==="+t.deviceId),e.showLoading({title:"连接中...",mask:!0}),e.createBLEConnection({deviceId:t.deviceId,success:function(n){console.log("连接deviceId",t.deviceId),e.hideLoading(),e.showToast({title:"连接成功",duration:1e3}),e.getBLEDeviceServices({deviceId:t.deviceId,success:function(e){for(var n=e.services,a=n.length,c=0;c<a;c++){var i=n[c].uuid,o=i.slice(4,8);if("FFE0"==o||"ffe0"==o){var r=c;t.setData({serviceId:n[r].uuid})}}t.Characteristics()}})},fail:function(t){console.log("res==="+t.errMsg),e.hideLoading(),e.showModal({title:"提示",content:"连接失败，请确认设备是否在线",showCancel:!1,success:function(t){t.confirm&&e.switchTab({url:"../device/device"})}})}})}})},onShow:function(){},onHide:function(){},onUnload:function(){},onPullDownRefresh:function(){},onReachBottom:function(){},onShareAppMessage:function(){},methods:{handle:function(e){this.setData({val:e.target.dataset.money,money_value:e.target.dataset.value,tempid:e.target.dataset.id})},getTemp:function(t){var n=this;console.log("设备号==="+t),e.request({url:"https://app.tengfuchong.com/applet/getTemps?code="+t,method:"POST",success:function(e){if(console.log(e.data),0==e.data.length&&n.setData({money_value:2,val:2}),1==e.data.length)n.setData({items:e.data,money_value:e.data[0].remark,val:e.data[0].money,tempid:e.data[0].id});else for(var t in e.data)console.log(t+"="+e.data[t].name),n.setData({items:e.data,money_value:e.data[1].remark,val:e.data[1].money,tempid:e.data[1].id})}})},Characteristics:function(){var t=this;e.getBLEDeviceCharacteristics({deviceId:t.deviceId,serviceId:t.serviceId,success:function(e){for(var n=e.characteristics,a=n.length,c=0;c<a;c++){var i=n[c].uuid,o=i.slice(4,8);if("FFE1"==o||"ffe1"==o){var r=c;t.setData({notycharacteristicsId:n[r].uuid,characteristicsId:n[r].uuid});for(c=0;c<a;c++){var s=n[c].uuid;o=s.slice(4,8);if("FEE2"==o||"fee2"==o){r=c;t.setData({characteristicsId:n[r].uuid})}}}}t.notycharacteristicsIdFun()}})},notycharacteristicsIdFun:function(){var t=this,n="";e.notifyBLECharacteristicValueChange({deviceId:t.deviceId,serviceId:t.serviceId,characteristicId:t.notycharacteristicsId,state:!0,success:function(a){e.onBLECharacteristicValueChange((function(a){for(var c=[],i="",o="",r=a.value,s=t.buf2hex(r),u=s,d=u.length/2,l=Math.round(d),f=0;f<l;f++){var h=u.slice(0,2);c.push(h),u=u.substring(2)}for(var v=0;v<c.length;v++){var m=c[v];n=parseInt(m,16),i+=String.fromCharCode(n),o+=m}"5504830100d2"==o&&(e.hideLoading(),e.showToast({title:"投币成功"}));var g=t.recv_number+i.length,p=Math.round(g);t.setData({recv_number:p,recv_value:t.recv_value+i})}))},fail:function(e){}})},Sendincoins:function(){var t=this;console.log("---发送money"+t.money_value),e.openBluetoothAdapter({success:function(e){var n="aa",a="83",c="04",i="01",o="0"+t.port,r=t.money_value+""||"02",s=r.length;s<2&&s>0&&(r="0"+r);var u=a^c^i^o^r,d=n+""+a+c+i+o+r+u;if(d.length>20)if(1==t.send_string){for(var l=d,f=Math.ceil(l.length/20),h=0;h<f;h++)if(l.length>20){var v=l.slice(0,20);l=l.substring(20),write_array.push(v)}else write_array.push(l);write_array.map((function(e,n){setTimeout((function(){var n=e;t.write(n)}),100*n)}));var m=t.send_number+d.length/2,g=Math.floor(m);t.setData({send_number:g})}else{var p=d.split("");for(h=0;h<p.length;h++)value_ascii+=p[h].charCodeAt().toString(16);var I=value_ascii,_=Math.ceil(I.length/20);for(h=0;h<_;h++)if(I.length>20){var w=I.slice(0,20);I=I.substring(20),write_array.push(w)}else{w=I;write_array.push(I)}write_array.map((function(e,n){setTimeout((function(){var n=e;t.write(n)}),100*n)}));m=t.send_number+d.length,g=Math.round(m);t.setData({send_number:g})}else{w=d,t.write(w),m=t.send_number+d.length/2,g=Math.floor(m);t.setData({send_number:g})}},fail:function(t){e.showModal({content:"请开启手机蓝牙后再试",success:function(){e.switchTab({url:"../device/device",success:function(){},fail:function(e){}})}})}})},write:function(t){var n=this,a=t,c=a.length;c<2&&c>0&&(a="0"+a),console.log("---"+a);var i=new Uint8Array((a+"\r\n").match(/[\da-f]{2}/gi).map((function(e){return parseInt(e,16)}))),o=i.buffer;e.writeBLECharacteristicValue({deviceId:n.deviceId,serviceId:n.serviceId,characteristicId:n.characteristicsId,value:o,success:function(e){return console.log("数据发送成功",e),!0},fail:function(t){e.writeBLECharacteristicValue({deviceId:n.deviceId,serviceId:n.serviceId,characteristicId:n.characteristicsId,value:o,success:function(e){return!0},fail:function(t){console.log("第2次调用失败",t),e.writeBLECharacteristicValue({deviceId:n.deviceId,serviceId:n.serviceId,characteristicId:n.characteristicsId,value:o,success:function(e){return!0},fail:function(e){return!1}})}})}})},Payincoins:function(){var t=this;t.setData({disabled:!0}),e.connectSocket({url:"wss://app.tengfuchong.com/websocket",success:function(e){console.log("socket连接打开==="+JSON.stringify(e))}}),e.onSocketMessage((function(n){var a=n.data;1==a&&(t.senddata(),e.closeSocket())})),e.openBluetoothAdapter({success:function(n){var a=t.openid;console.log(a),e.request({url:"https://app.tengfuchong.com/testpay/pay",data:{openId:a,tempid:t.tempid,code:t.deviceName,port:t.port},header:{"content-type":"application/x-www-form-urlencoded"},method:"POST",success:function(e){t.doWxPay(e.data)},fail:function(t){e.showToast({icon:"none",title:"服务器异常，清稍候再试"})}})},fail:function(){e.showModal({content:"请开启手机蓝牙后再试",success:function(){e.switchTab({url:"../device/device",success:function(){},fail:function(e){}})}})}})},doWxPay:function(t){var n=this;e.requestPayment({timeStamp:t.timeStamp,nonceStr:t.nonceStr,package:t.packagess,signType:"MD5",paySign:t.paySign,success:function(t){e.showToast({title:"支付成功",icon:"success",duration:2e3,success:function(){e.showToast({title:"支付成功",success:function(t){e.closeBLEConnection({deviceId:n.deviceId,success:function(t){e.switchTab({url:"../device/device"})}})}})}})},fail:function(t){e.closeSocket(),e.showToast({title:"支付取消"}),n.setData({disabled:!1})},complete:function(){}})},checkBluetoothIfOpen:function(){e.openBluetoothAdapter({success:function(e){},fail:function(t){e.showModal({content:"请开启手机蓝牙后再试"}),e.navigateTo({url:"../device/device"})}})},senddata:function(){var e=this,t="aa",n="83",a="04",c="01",i="0"+e.port,o=e.money_value+""||"02",r=o.length;r<2&&r>0&&(o="0"+o);var s=n^a^c^i^o,u=t+""+n+a+c+i+o+s;if(u.length>20)if(1==e.send_string){for(var d=u,l=Math.ceil(d.length/20),f=0;f<l;f++)if(d.length>20){var h=d.slice(0,20);d=d.substring(20),write_array.push(h)}else write_array.push(d);write_array.map((function(t,n){setTimeout((function(){var n=t;e.write(n)}),100*n)}));var v=e.send_number+u.length/2,m=Math.floor(v);e.setData({send_number:m})}else{var g=u.split("");for(f=0;f<g.length;f++)value_ascii+=g[f].charCodeAt().toString(16);var p=value_ascii,I=Math.ceil(p.length/20);for(f=0;f<I;f++)if(p.length>20){var _=p.slice(0,20);p=p.substring(20),write_array.push(_)}else{_=p;write_array.push(p)}write_array.map((function(t,n){setTimeout((function(){var n=t;e.write(n)}),100*n)}));v=e.send_number+u.length,m=Math.round(v);e.setData({send_number:m})}else{_=u,e.write(_),v=e.send_number+u.length/2,m=Math.floor(v);e.setData({send_number:m})}},buf2hex:function(e){return Array.prototype.map.call(new Uint8Array(e),(function(e){return("00"+e.toString(16)).slice(-2)})).join("")},base64_encode:function(e){var t,n,a,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",i=0,o=e.length,r="";while(i<o){if(t=255&e.charCodeAt(i++),i==o){r+=c.charAt(t>>2),r+=c.charAt((3&t)<<4),r+="==";break}if(n=e.charCodeAt(i++),i==o){r+=c.charAt(t>>2),r+=c.charAt((3&t)<<4|(240&n)>>4),r+=c.charAt((15&n)<<2),r+="=";break}a=e.charCodeAt(i++),r+=c.charAt(t>>2),r+=c.charAt((3&t)<<4|(240&n)>>4),r+=c.charAt((15&n)<<2|(192&a)>>6),r+=c.charAt(63&a)}return r},callPhone:function(){var t=this;console.log(t.phonenum),e.makePhoneCall({phoneNumber:t.phonenum,success:function(e){console.log("呼叫电话返回：",e)}})},Backhome:function(){var t=this;e.closeBLEConnection({deviceId:t.deviceId,success:function(t){e.switchTab({url:"../device/device"})}})},inadver:function(){e.navigateTo({url:"../ad/ad"})}}};t.default=a}).call(this,n("543d")["default"])},e66a:function(e,t,n){"use strict";var a=n("7f07"),c=n.n(a);c.a},f08d:function(e,t,n){"use strict";(function(e){n("fd64");a(n("66fd"));var t=a(n("765c"));function a(e){return e&&e.__esModule?e:{default:e}}wx.__webpack_require_UNI_MP_PLUGIN__=n,e(t.default)}).call(this,n("543d")["createPage"])}},[["f08d","common/runtime","common/vendor"]]]);