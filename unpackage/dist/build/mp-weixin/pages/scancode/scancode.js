(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/scancode/scancode"],{"1df8":function(e,t,n){"use strict";(function(e){n("c4da");c(n("66fd"));var t=c(n("830a"));function c(e){return e&&e.__esModule?e:{default:e}}wx.__webpack_require_UNI_MP_PLUGIN__=n,e(t.default)}).call(this,n("543d")["createPage"])},"27e4":function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;getApp();var c=n("3182"),a={data:function(){return{items:[{name:"1",value:"1元"},{name:"2",value:"2元",checked:"true"},{name:"3",value:"3元"},{name:"4",value:"4元"},{name:"5",value:"5元"},{name:"6",value:"6元"}],subcode:"",deviceId:"",money_value:"",deviceName:"",serviceId:"",notycharacteristicsId:"",characteristicsId:"",recv_number:"",recv_value:"",send_number:""}},onLoad:function(t){console.log("index 生命周期 onload"+JSON.stringify(t));var n=decodeURIComponent(t.q);n&&(console.log("index 生命周期 onload url="+n),console.log("index 生命周期 onload 参数 flag="+c.getQueryString(n,"flag")));var a=n.indexOf("https://www.tengfuchong.cn/applet");if(-1!=a){var i=n.lastIndexOf("/"),o=n.substr(i+1);console.log("index"+i+"---截取字符串==="+o),this.setData({subcode:o,deviceId:null})}e.login({success:function(t){if(t.code){e.getUserInfo({withCredentials:!0,success:function(t){var n={};n.avatarUrl=t.userInfo.avatarUrl,n.nickName=t.userInfo.nickName,e.setStorageSync("userInfo",n)}});var n="https://api.weixin.qq.com/sns/jscode2session?appid=wxd055087c1caa71a6&secret=c94124dcb3eeecc068802f4025ecb8a0&js_code="+t.code+"&grant_type=authorization_code";e.request({url:n,data:{},method:"GET",success:function(t){var n={};n.openid=t.data.openid,e.setStorageSync("user",n)}})}}})},onReady:function(){var t=this;e.openBluetoothAdapter({success:function(n){var c=t.deviceId;console.log("deviceid==="+c),null!=c?(console.log("通过有值"),e.closeBLEConnection({deviceId:t.deviceId,success:function(e){t.WolfConnectDevice()}})):(console.log("不通过无值"),t.WolfConnectDevice())}})},onShow:function(){},onHide:function(){},onUnload:function(){},onPullDownRefresh:function(){},onReachBottom:function(){},onShareAppMessage:function(){},methods:{radioChange:function(e){this.setData({money_value:e.detail.value})},WolfConnectDevice:function(){var t=this;e.request({url:"https://app.tengfuchong.com/applet/findDeviceId",data:{code:t.subcode},header:{"content-type":"application/x-www-form-urlencoded"},method:"POST",success:function(n){var c=n.data;console.log("查询MAC地址==="+c),0==c?e.showModal({title:"提示",content:"设备不存在",showCancel:!1,success:function(e){e.confirm&&console.log("用户点击确定")}}):(t.setData({deviceId:c,deviceName:t.subcode}),console.log("初始化蓝牙适配器成功"),console.log("MAC==="+c),e.createBLEConnection({deviceId:c,success:function(n){console.log("连接deviceId",c),e.hideLoading(),e.showToast({title:"连接成功"}),e.getBLEDeviceServices({deviceId:t.deviceId,success:function(e){for(var n=e.services,c=n.length,a=0;a<c;a++){var i=n[a].uuid,o=i.slice(4,8);if("FFE0"==o||"ffe0"==o){var r=a;t.setData({serviceId:n[r].uuid})}}t.Characteristics()}})},fail:function(n){console.log("res==="+n.errMsg),e.hideLoading(),-1!=n.errMsg.indexOf("already connect")?e.closeBLEConnection({deviceId:t.deviceId,success:function(e){t.WolfConnectDevice()}}):e.showModal({title:"提示",content:"连接失败，请确认设备是否在线",showCancel:!1,success:function(t){t.confirm&&e.switchTab({url:"../device/device"})}})}}))},fail:function(t){console.log(t.data),e.showToast({icon:"none",title:"服务器异常，清稍候再试"})},complete:function(){e.hideLoading()}})},Characteristics:function(){var t=this;e.getBLEDeviceCharacteristics({deviceId:t.deviceId,serviceId:t.serviceId,success:function(e){for(var n=e.characteristics,c=n.length,a=0;a<c;a++){var i=n[a].uuid,o=i.slice(4,8);if("FFE1"==o||"ffe1"==o){var r=a;t.setData({notycharacteristicsId:n[r].uuid,characteristicsId:n[r].uuid});for(a=0;a<c;a++){var s=n[a].uuid;o=s.slice(4,8);if("FEE2"==o||"fee2"==o){r=a;t.setData({characteristicsId:n[r].uuid})}}}}t.notycharacteristicsIdFun()}})},notycharacteristicsIdFun:function(){var t=this,n="";e.notifyBLECharacteristicValueChange({deviceId:t.deviceId,serviceId:t.serviceId,characteristicId:t.notycharacteristicsId,state:!0,success:function(c){e.onBLECharacteristicValueChange((function(c){for(var a=[],i="",o="",r=c.value,s=t.buf2hex(r),u=s,d=u.length/2,l=Math.round(d),f=0;f<l;f++){var h=u.slice(0,2);a.push(h),u=u.substring(2)}for(var v=0;v<a.length;v++){var g=a[v];n=parseInt(g,16),i+=String.fromCharCode(n),o+=g}"5504830100d2"==o&&(e.hideLoading(),e.showToast({title:"投币成功"}));var p=t.recv_number+i.length,m=Math.round(p);t.setData({recv_number:m,recv_value:t.recv_value+i})}))},fail:function(e){}})},Sendincoins:function(){var t=this;e.openBluetoothAdapter({success:function(e){var n="aa",c="83",a="04",i="01",o="01",r=t.money_value||"02",s=r.length;s<2&&s>0&&(r="0"+r);var u=c^a^i^o^r,d=n+""+c+a+i+o+r+u;if(d.length>20)if(1==t.send_string){for(var l=d,f=Math.ceil(l.length/20),h=0;h<f;h++)if(l.length>20){var v=l.slice(0,20);l=l.substring(20),write_array.push(v)}else write_array.push(l);write_array.map((function(e,n){setTimeout((function(){var n=e;t.write(n)}),100*n)}));var g=t.send_number+d.length/2,p=Math.floor(g);t.setData({send_number:p})}else{var m=d.split("");for(h=0;h<m.length;h++)value_ascii+=m[h].charCodeAt().toString(16);var I=value_ascii,w=Math.ceil(I.length/20);for(h=0;h<w;h++)if(I.length>20){var _=I.slice(0,20);I=I.substring(20),write_array.push(_)}else{_=I;write_array.push(I)}write_array.map((function(e,n){setTimeout((function(){var n=e;t.write(n)}),100*n)}));g=t.send_number+d.length,p=Math.round(g);t.setData({send_number:p})}else{_=d,t.write(_),g=t.send_number+d.length/2,p=Math.floor(g);t.setData({send_number:p})}},fail:function(t){e.showModal({content:"请开启手机蓝牙后再试",success:function(){e.switchTab({url:"../device/device",success:function(){},fail:function(e){}})}})}})},write:function(t){var n=this,c=t,a=c.length;a<2&&a>0&&(c="0"+c);var i=new Uint8Array((c+"\r\n").match(/[\da-f]{2}/gi).map((function(e){return parseInt(e,16)}))),o=i.buffer;e.writeBLECharacteristicValue({deviceId:n.deviceId,serviceId:n.serviceId,characteristicId:n.characteristicsId,value:o,success:function(e){console.log("数据发送成功",e)},fail:function(t){e.writeBLECharacteristicValue({deviceId:n.deviceId,serviceId:n.serviceId,characteristicId:n.characteristicsId,value:o,success:function(e){},fail:function(t){console.log("第2次调用失败",t),e.writeBLECharacteristicValue({deviceId:n.deviceId,serviceId:n.serviceId,characteristicId:n.characteristicsId,value:o,success:function(e){},fail:function(t){e.showModal({title:"提示",content:"设备不在线或距离较远",showCancel:!1,success:function(t){t.confirm&&e.switchTab({url:"../device/device"})}})}})}})}})},Payincoins:function(){var t=this;e.openBluetoothAdapter({success:function(n){var c=e.getStorageSync("user")||{};e.request({url:"https://app.tengfuchong.com/testpay/pay",data:{openId:c.openid,money:t.money_value||2},header:{"content-type":"application/x-www-form-urlencoded"},method:"POST",success:function(e){t.doWxPay(e.data)},fail:function(t){e.showToast({icon:"none",title:"服务器异常，清稍候再试"})}})},fail:function(){e.showModal({content:"请开启手机蓝牙后再试",success:function(){e.switchTab({url:"../device/device",success:function(){},fail:function(e){}})}})}})},doWxPay:function(t){var n=this;e.requestPayment({timeStamp:t.timeStamp,nonceStr:t.nonceStr,package:t.packagess,signType:"MD5",paySign:t.paySign,success:function(t){n.senddata(),e.showToast({title:"支付成功",icon:"success",duration:2e3})},fail:function(e){},complete:function(){}})},checkBluetoothIfOpen:function(){e.openBluetoothAdapter({success:function(e){},fail:function(t){e.showModal({content:"请开启手机蓝牙后再试"}),e.navigateTo({url:"../device/device"})}})},senddata:function(){var e=this,t="aa",n="83",c="04",a="01",i="01",o=e.money_value||"02",r=o.length;r<2&&r>0&&(o="0"+o);var s=n^c^a^i^o,u=t+""+n+c+a+i+o+s;if(u.length>20)if(1==e.send_string){for(var d=u,l=Math.ceil(d.length/20),f=0;f<l;f++)if(d.length>20){var h=d.slice(0,20);d=d.substring(20),write_array.push(h)}else write_array.push(d);write_array.map((function(t,n){setTimeout((function(){var n=t;e.write(n)}),100*n)}));var v=e.send_number+u.length/2,g=Math.floor(v);e.setData({send_number:g})}else{var p=u.split("");for(f=0;f<p.length;f++)value_ascii+=p[f].charCodeAt().toString(16);var m=value_ascii,I=Math.ceil(m.length/20);for(f=0;f<I;f++)if(m.length>20){var w=m.slice(0,20);m=m.substring(20),write_array.push(w)}else{w=m;write_array.push(m)}write_array.map((function(t,n){setTimeout((function(){var n=t;e.write(n)}),100*n)}));v=e.send_number+u.length,g=Math.round(v);e.setData({send_number:g})}else{w=u,e.write(w),v=e.send_number+u.length/2,g=Math.floor(v);e.setData({send_number:g})}},buf2hex:function(e){return Array.prototype.map.call(new Uint8Array(e),(function(e){return("00"+e.toString(16)).slice(-2)})).join("")},base64_encode:function(e){var t,n,c,a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",i=0,o=e.length,r="";while(i<o){if(t=255&e.charCodeAt(i++),i==o){r+=a.charAt(t>>2),r+=a.charAt((3&t)<<4),r+="==";break}if(n=e.charCodeAt(i++),i==o){r+=a.charAt(t>>2),r+=a.charAt((3&t)<<4|(240&n)>>4),r+=a.charAt((15&n)<<2),r+="=";break}c=e.charCodeAt(i++),r+=a.charAt(t>>2),r+=a.charAt((3&t)<<4|(240&n)>>4),r+=a.charAt((15&n)<<2|(192&c)>>6),r+=a.charAt(63&c)}return r}}};t.default=a}).call(this,n("543d")["default"])},"3abf":function(e,t,n){"use strict";var c;n.d(t,"b",(function(){return a})),n.d(t,"c",(function(){return i})),n.d(t,"a",(function(){return c}));var a=function(){var e=this,t=e.$createElement;e._self._c},i=[]},"49bc":function(e,t,n){"use strict";n.r(t);var c=n("27e4"),a=n.n(c);for(var i in c)"default"!==i&&function(e){n.d(t,e,(function(){return c[e]}))}(i);t["default"]=a.a},"5e70":function(e,t,n){"use strict";var c=n("8241"),a=n.n(c);a.a},8241:function(e,t,n){},"830a":function(e,t,n){"use strict";n.r(t);var c=n("3abf"),a=n("49bc");for(var i in a)"default"!==i&&function(e){n.d(t,e,(function(){return a[e]}))}(i);n("5e70");var o,r=n("f0c5"),s=Object(r["a"])(a["default"],c["b"],c["c"],!1,null,null,null,!1,c["a"],o);t["default"]=s.exports}},[["1df8","common/runtime","common/vendor"]]]);